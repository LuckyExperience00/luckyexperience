<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lucky Experience - Ruota della Fortuna</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f7f7f7; color:#222; margin:0; padding:30px; text-align:center; }
    .card { background:#fff; border-radius:10px; padding:20px; display:inline-block; box-shadow:0 6px 18px rgba(0,0,0,0.06); }
    h1 { margin:0 0 12px; font-size:22px; }
    p { margin:0 0 18px; color:#555; }
    #paypal-container { margin-bottom:18px; }
    #spin-button { display:none; margin: 12px auto; padding:10px 18px; background:#0070ba; color:#fff; border:none;border-radius:8px; cursor:pointer; font-size:16px; }
    #spin-button[disabled]{ opacity:0.6; cursor:not-allowed; }
    #wheel-wrap{ position:relative; display:inline-block; margin-top:14px;}
    canvas{ width:320px; height:320px; max-width:90vw; border-radius:50%; display:block; }
    #overlay { display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); border-radius:50%; }
    footer{ margin-top:18px; color:#777; font-size:13px; }
  </style>
  <!-- PayPal SDK (client-id tuo) -->
  <script src="https://www.paypal.com/sdk/js?client-id=BAAN6bRif0SiRgIVogFIdoXGcyTo8yCOdtp86-1BFsjPk9efx1Hid7QRfndhe3Oyv24vh_BQcCnnk1fsIY&components=hosted-buttons&currency=EUR"></script>
</head>
<body>
  <div class="card">
    <h1>ðŸŽ¯ Lucky Experience</h1>
    <p>Paga e prova a vincere: un solo giro consentito per utente/browser.</p>

    <!-- Contenitore PayPal (Hosted Button) -->
    <div id="paypal-container"></div>

    <!-- Pulsante "Gira" che appare solo dopo pagamento -->
    <button id="spin-button">Gira la Ruota!</button>

    <!-- Ruota -->
    <div id="wheel-wrap">
      <canvas id="wheelCanvas" width="500" height="500"></canvas>
      <div id="overlay"></div>
    </div>

    <footer>Se non vedi la ruota subito dopo il pagamento, assicurati che PayPal reindirizzi a questa pagina con <code>?paid=1</code>.</footer>
  </div>

<script>
/* ===========================
   CONFIGURAZIONE - modifica qui se vuoi
   =========================== */
const HOSTED_BUTTON_ID = "EVWS5RHG3HSQS"; // il tuo Hosted Button ID
const RETURN_URL = "https://davidflow00.github.io/luckyexperience/?paid=1"; // metti questo in PayPal come Return URL

// Premi della ruota - modifica a piacere
const prizes = ["Sconto 5â‚¬","Riprova","Sconto 10â‚¬","Niente","Sorpresa!","Sconto 15â‚¬"];
const colors = ["#FFCDD2","#F8BBD0","#E1BEE7","#C5CAE9","#BBDEFB","#B2DFDB"];
/* ===========================
   Fine configurazione
   =========================== */

/* elementi UI */
const paypalContainer = document.getElementById("paypal-container");
const spinBtn = document.getElementById("spin-button");
const canvas = document.getElementById("wheelCanvas");
const ctx = canvas.getContext("2d");
const overlay = document.getElementById("overlay");

/* disegna la ruota */
function drawWheelBase(rotation=0) {
  const num = prizes.length;
  const cx = canvas.width/2, cy = canvas.height/2, r = canvas.width/2;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const arc = 2*Math.PI/num;
  ctx.save();
  ctx.translate(cx,cy);
  ctx.rotate(rotation);
  for(let i=0;i<num;i++){
    ctx.beginPath();
    ctx.moveTo(0,0);
    ctx.arc(0,0,r,i*arc,(i+1)*arc);
    ctx.fillStyle = colors[i%colors.length];
    ctx.fill();
    ctx.save();
    ctx.rotate(i*arc + arc/2);
    ctx.fillStyle="#111";
    ctx.textAlign="right";
    ctx.font = "18px Arial";
    ctx.fillText(prizes[i], r-10, 6);
    ctx.restore();
  }
  ctx.restore();

  // disegna freccia in alto
  ctx.fillStyle = "#222";
  ctx.beginPath();
  ctx.moveTo(cx-10, 10);
  ctx.lineTo(cx+10, 10);
  ctx.lineTo(cx, 28);
  ctx.fill();
}

/* inizializza ruota */
drawWheelBase();

/* Spin logic */
let isSpinning = false;
function spinWheel(){
  if(isSpinning) return;
  if(localStorage.getItem("girata")==="true"){
    alert("Hai giÃ  utilizzato il tuo giro.");
    return;
  }
  isSpinning = true;
  spinBtn.disabled = true;

  const totalDeg = Math.random()*360 + 1080; // almeno 3 giri
  const duration = 4500;
  const start = performance.now();

  function frame(now){
    let t = (now - start)/duration;
    if(t>1) t=1;
    const ease = 1 - Math.pow(1 - t, 3);
    const deg = ease * totalDeg;
    const rad = deg * Math.PI/180;
    drawWheelBase(rad);
    if(t < 1) requestAnimationFrame(frame);
    else {
      isSpinning = false;
      localStorage.setItem("girata","true");
      overlay.style.display = "block";
      // calcolo vincitore
      const landed = (360 - (totalDeg % 360)) % 360; // angolo rispetto alla freccia
      const slice = 360 / prizes.length;
      let index = Math.floor(landed / slice);
      // ruota disegnata con prizes[0] in primo settore: invertiamo per corrispondenza visiva
      const winner = prizes[(prizes.length - 1 - index + prizes.length) % prizes.length];
      setTimeout(() => alert("Hai vinto: " + winner), 200);
    }
  }
  requestAnimationFrame(frame);
}

/* mostra il pulsante spin se Ã¨ stato pagato */
function enableSpinUI(){
  // se giÃ  girato, mostri overlay e niente spin
  if(localStorage.getItem("girata")==="true"){
    overlay.style.display = "block";
    spinBtn.style.display = "none";
    return;
  }
  spinBtn.style.display = "inline-block";
  spinBtn.disabled = false;
}

/* PayPal Hosted Button render */
paypal.HostedButtons({
  hostedButtonId: HOSTED_BUTTON_ID,
  // se PayPal riesce a chiamare onApprove, abilitiamo la ruota immediatamente
  onApprove: function(data, actions) {
    // segnalo che Ã¨ stato pagato (localmente) e abilito spin
    try { localStorage.setItem("paid_flag","true"); } catch(e){}
    enableSpinUI();
    alert("Pagamento confermato! Ora puoi girare.");
  }
}).render("#paypal-container");

/* Fallback: rileva se la pagina Ã¨ stata caricata con ?paid=1 (PayPal redirect) */
function checkUrlForPaid(){
  const params = new URLSearchParams(window.location.search);
  if(params.get("paid") === "1" || localStorage.getItem("paid_flag")==="true"){
    // pulito l'URL (rimuovo param) per non ripetere l'azione se ricarica
    if(params.get("paid") === "1"){
      // rimuoviamo query string dallo storico per pulizia
      const cleanUrl = window.location.origin + window.location.pathname;
      window.history.replaceState({}, document.title, cleanUrl);
    }
    enableSpinUI();
  }
}

/* Attiva controllo all'avvio */
document.addEventListener("DOMContentLoaded", function(){
  checkUrlForPaid();
});

/* click sul pulsante spin */
spinBtn.addEventListener("click", spinWheel);
</script>
</body>
</html>
